---
apiVersion: v1
kind: ConfigMap
metadata:
  name: harvex-config
  namespace: harvex
data:
  HARVEX__SERVER__HOST: "0.0.0.0"
  HARVEX__SERVER__PORT: "3000"
  HARVEX__DATABASE__PATH: "/app/data/db/harvex.duckdb"
  HARVEX__STORAGE__UPLOAD_DIR: "/app/data/uploads"
  HARVEX__STORAGE__MAX_FILE_SIZE_MB: "50"
  HARVEX__PROCESSING__MAX_CONCURRENT: "2"
  HARVEX__LLM__API_URL: "http://10.10.20.11:11434/v1"
  HARVEX__LLM__API_KEY: ""
  HARVEX__LLM__MODEL_NAME: "qwen2.5:7b"
  HARVEX__LLM__CONTEXT_SIZE: "4096"
  HARVEX__LLM__TEMPERATURE: "0.1"
  HARVEX__LLM__MAX_TOKENS: "2048"
  HARVEX__LLM__VISION_MODEL_NAME: "qwen2.5vl:7b"
  HARVEX__LLM__VISION_DPI: "200"
  HARVEX__LLM__VISION_MAX_PAGES: "5"
  RUST_LOG: "info,harvex_api=debug,harvex_services=debug"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: harvex
  namespace: harvex
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: harvex
  template:
    metadata:
      labels:
        app: harvex
    spec:
      nodeSelector:
        kubernetes.io/hostname: k8s-worker-2
      containers:
        - name: harvex
          image: harvex:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 80
              name: http
          envFrom:
            - configMapRef:
                name: harvex-config
          volumeMounts:
            - name: harvex-data
              mountPath: /app/data
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 512Mi
          startupProbe:
            tcpSocket:
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            periodSeconds: 30
            timeoutSeconds: 5
      volumes:
        - name: harvex-data
          hostPath:
            path: /data/harvex
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: harvex
  namespace: harvex
spec:
  type: NodePort
  selector:
    app: harvex
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30060
